# 1 前言

## 1.1 小型嵌入式系统中的多任务

### 1.1.1 关于 FreeRTOS 内核

FreeRTOS 是一组 C 语言库，包括一个实时内核和一组实现补充功能的模块化库。

Richard Barry 于 2003 年左右最初开发了 FreeRTOS。Richard 的公司 Real-Time Engineers Ltd 与全球领先的芯片公司密切合作，持续开发 FreeRTOS，直到 2016 年 Amazon Web Services (AWS) 接管了 FreeRTOS 的管理。现在 Richard 作为 AWS IoT 团队的高级首席工程师继续从事 FreeRTOS 的相关工作。FreeRTOS 采用 MIT 开源许可证，任何用途均可免费使用。你无需成为 AWS 客户也能受益于 AWS 的管理！

FreeRTOS 内核非常适合运行在微控制器或小型微处理器上的深度嵌入式实时应用。这类应用通常包含硬实时和软实时需求的混合。

软实时需求要求在某个时间点前完成任务，但超时不会导致系统失效。例如，响应按键过慢可能让系统显得反应迟缓，但并不会让系统无法使用。

硬实时需求要求在某个时间点前完成任务，超时将导致系统彻底失效。例如，安全气囊如果对碰撞传感器输入响应过慢，可能会造成更大的伤害。

FreeRTOS 内核是一个实时内核（或实时调度器），使基于 FreeRTOS 的应用能够满足其硬实时需求。它允许应用被组织为一组独立的执行线程。例如，在只有一个内核的处理器上，同一时刻只能有一个线程在执行。内核通过检查应用设计者为每个线程分配的优先级来决定执行哪个线程。最简单的情况下，设计者可以为实现硬实时需求的线程分配更高优先级，为实现软实时需求的线程分配较低优先级。这种分配可以确保硬实时线程总是优先于软实时线程执行，但实际优先级分配并不总是如此简单。

如果你还没有完全理解上面段落中的概念，不必担心。后续章节会通过详细解释和大量示例，帮助你理解如何使用实时内核，尤其是 FreeRTOS。

### 1.1.2 价值主张

FreeRTOS 内核取得全球性成功，源于其极具吸引力的价值主张：FreeRTOS 由专业团队开发，严格质量控制，健壮可靠，支持完善，无知识产权归属歧义，并且在商业应用中真正免费，无需公开你的专有源代码。此外，AWS 的管理带来了全球影响力、专业的安全事件响应流程、庞大且多元化的开发团队、形式化验证、渗透测试、内存安全证明和长期支持——同时保持 FreeRTOS 作为硬件、开发工具和云服务中立的开源项目。FreeRTOS 的开发在 GitHub 上透明且由社区驱动，无需特殊工具或开发流程。

你可以直接用 FreeRTOS 推出产品，无需告知我们，更无需支付任何费用，成千上万家公司正是这样做的。如果你希望获得额外支持，或你的法务团队需要额外的书面担保或赔偿，我们的战略合作伙伴也提供简单低价的商业授权选项。你可以随时选择商业授权，获得更高的保障。

### 1.1.3 关于术语的说明

在 FreeRTOS 中，每个执行线程被称为“任务”（task）。嵌入式领域对术语并无统一标准，但我更喜欢“任务”而不是“线程”，因为“线程”在某些领域有更具体的含义。

### 1.1.4 为什么要使用 RTOS？

有许多成熟的方法可以在不使用多线程内核的情况下编写优秀的嵌入式软件。如果开发的系统很简单，这些方法可能是最合适的解决方案。对于更复杂的系统，使用内核通常更有优势，但两者的分界点总是主观的。

如前所述，任务优先级有助于确保应用满足处理时限，但内核还能带来其他不那么明显的好处，部分如下：

- 屏蔽时序信息
  RTOS 负责执行时序，并为应用提供与时间相关的 API，使应用代码结构更清晰，整体代码量更小。
- 可维护性/可扩展性
  屏蔽时序细节减少了模块间的依赖，使软件能够以可控、可预测的方式演进。内核负责时序，因此应用性能对底层硬件变化不敏感。
- 模块化
  任务是独立的模块，每个任务应有明确的功能。
- 团队开发
  任务应有明确的接口，便于团队协作开发。
- 更易测试
  结构清晰、接口干净的独立任务更易于单独测试。
- 代码复用
  模块化和低耦合的代码更易于复用。
- 提高效率
  使用 RTOS 的应用可以完全事件驱动，无需为未发生的事件轮询浪费处理时间。
  当然，事件驱动带来的效率提升需要处理 RTOS 的时钟中断和任务切换，但不使用 RTOS 的应用通常也会有某种时钟中断。
- 空闲时间
  当没有应用任务需要处理时，自动创建的空闲任务会执行。空闲任务可用于测量剩余处理能力、执行后台检查或将处理器置于低功耗模式。
- 电源管理
  使用 RTOS 提高的效率使处理器能有更多时间处于低功耗模式。每次空闲任务运行时将处理器置于低功耗状态，可显著降低功耗。FreeRTOS 还支持特殊的无时钟（tick-less）模式，使处理器能进入更深的低功耗状态并保持更长时间。
- 灵活的中断处理
  可通过将处理延迟到应用创建的任务或自动创建的 RTOS 守护任务（定时器任务）来缩短中断处理程序。
- 混合处理需求
  简单的设计模式即可实现周期性、持续性和事件驱动的处理。通过合理选择任务和中断优先级，还能同时满足硬实时和软实时需求。

### 1.1.5 FreeRTOS 内核特性

FreeRTOS 内核具备以下标准特性：

- 抢占式或协作式运行
- 可选时间片轮转
- 非常灵活的任务优先级分配
- 灵活、快速且轻量的任务通知机制
- 队列
- 二值信号量
- 计数信号量
- 互斥量
- 递归互斥量
- 软件定时器
- 事件组
- 流缓冲区
- 消息缓冲区
- 协程（已弃用）
- 时钟钩子函数
- 空闲钩子函数
- 堆栈溢出检查
- 跟踪宏
- 任务运行时统计
- 可选商业授权与支持
- 完整的中断嵌套模型（部分架构支持）
- 针对极低功耗应用的无时钟能力（部分架构支持）
- 支持内存保护单元以隔离任务并提升应用安全性（部分架构支持）
- 适当时可由软件管理的中断堆栈（有助于节省 RAM）
- 支持静态或动态分配 RTOS 对象

### 1.1.6 许可协议及 FreeRTOS、OpenRTOS 和 SafeRTOS 家族

**FreeRTOS** 采用 MIT 开源许可证，旨在确保：

- FreeRTOS 可用于商业应用。
- FreeRTOS 本身对所有人免费开放。
- FreeRTOS 用户保留其知识产权所有权。

最新开源许可信息见 <https://www.FreeRTOS.org/license>。

**OpenRTOS** 是由第三方在 AWS 授权下提供的 FreeRTOS 商业授权版本。

**SafeRTOS** 与 FreeRTOS 使用模式相同，但其开发过程符合多项国际安全标准的合规要求。

## 1.2 附带的源文件和工程

### 1.2.1 获取本书配套示例

可通过 <https://www.FreeRTOS.org/Documentation/code> 下载的 zip 文件包含本书示例所需的全部源代码、预配置工程文件和构建运行说明。注意该 zip 文件未必包含 FreeRTOS 的最新版本。

本书中的截图展示了在 Microsoft Windows 环境下运行的示例，使用的是 FreeRTOS Windows 移植版。该工程已预配置为使用免费版 Visual Studio Community 进行构建，下载地址为 <https://www.visualstudio.com/>。需要注意，FreeRTOS Windows 移植版仅用于评估、测试和开发，并不具备真正的实时行为。

