# 1 前言

## 1.1 小型嵌入式系统中的多任务

### 1.1.1 关于 FreeRTOS 内核

FreeRTOS 是一组 C 语言库，包含实时内核以及一套实现补充功能的模块化库。

Richard Barry 大约在 2003 年最初开发了 FreeRTOS。Richard 所在的公司
Real-Time Engineers Ltd 与世界领先的芯片公司紧密合作，持续推进 FreeRTOS
发展，直到 2016 年由 Amazon Web Services (AWS) 接管 FreeRTOS 的主导维护。
Richard 现在在 AWS IoT 团队担任高级首席工程师，继续从事 FreeRTOS 的工作。
FreeRTOS 采用 MIT 许可证的开源代码，可用于任何用途。你无需成为 AWS 客户
也能从 AWS 的维护中受益！

FreeRTOS 内核非常适合运行在微控制器或小型微处理器上的深度嵌入式实时应用。
这类应用通常同时包含硬实时与软实时需求。

软实时需求会规定时间期限——但即便错过期限也不会使系统失效。
例如，对按键响应过慢可能会让系统显得令人不耐烦，但并不会真正变得不可用。

硬实时需求也会规定时间期限——但一旦错过期限就会导致系统彻底失效。
例如，驾驶员安全气囊如果对碰撞传感器输入响应过慢，就可能弊大于利。

FreeRTOS 内核是一个实时内核（或实时调度器），使基于 FreeRTOS 构建的
应用能够满足其硬实时需求。它让应用可以组织为一组相互独立的执行线程。
例如，在只有一个核心的处理器上，任一时刻只能有一个执行线程运行。内核通过
查看应用设计者分配给各线程的优先级来决定执行哪个线程。在最简单的情况下，
应用设计者可给实现硬实时需求的线程分配更高优先级，给实现软实时需求的线程
分配更低优先级。如此分配可确保硬实时线程总是在软实时线程之前执行，但优先级
分配决策并不总是如此简单。

如果你还没有完全理解上一段中的概念也无需担心。后续章节将提供详细解释，并
配以大量示例，帮助你理解如何使用实时内核，尤其是 FreeRTOS。


### 1.1.2 价值主张

FreeRTOS 内核取得前所未有的全球成功，源于其强大的价值主张；FreeRTOS 经过
专业开发、严格质量控制、稳健可靠、有支持保障、不含知识产权归属不明确的
问题，并且可在商业应用中真正免费使用，而无需公开你的专有源代码。此外，
AWS 的主导维护带来了全球化覆盖、专业的安全事件响应流程、规模庞大且多元的
开发团队、形式化验证专长、渗透测试、内存安全证明以及长期支持——同时始终
保持 FreeRTOS 作为硬件、开发工具与云服务中立的开源项目。FreeRTOS 的开发在
GitHub 上透明、由社区驱动，不需要任何特殊工具或开发实践。

你可以使用 FreeRTOS 把产品推向市场，甚至无需通知我们，更无需支付任何费用，
已有成千上万家公司这样做。如果你希望获得额外的后备支持，或你的法务团队
需要额外的书面保证或赔偿条款，我们的战略合作伙伴可提供简单、低成本的商业
许可选项。安心来自于这样的认知：你可以在任何时候选择商业化路径。


### 1.1.3 术语说明

在 FreeRTOS 中，每个执行线程被称为“任务”。嵌入式领域对术语并无统一共识，
但我更倾向于使用“任务”而非“线程”，因为在某些应用领域中“线程”可能有更
特定的含义。


### 1.1.4 为什么使用 RTOS？

在不使用多线程内核的情况下，也有许多成熟的方法可以编写良好的嵌入式软件。
如果所开发的系统很简单，这些方法可能是最合适的方案。在更复杂的情况下，
使用内核往往更优，但“复杂到何种程度就需要内核”的分界点始终带有主观性。

如前所述，任务优先级可以帮助应用满足处理时限，但内核还能带来其他不那么
显而易见的收益，下面仅做简要列举。

- 屏蔽时间信息

	RTOS 负责执行时序，并向应用提供时间相关的 API。这使应用代码结构更直接，
	整体代码规模更小。

- 可维护性/可扩展性

	屏蔽时间细节可减少模块间依赖，使软件能够以可控、可预测的方式演进。
	同时，由内核负责时序，应用性能也更不易受到底层硬件变化的影响。

- 模块化

	任务是相互独立的模块，每个任务都应有明确的目的。

- 团队开发

	任务还应有清晰接口，从而更易于团队协作开发。

- 更易测试

	定义良好且接口清晰的独立任务更易于进行单元级测试。

- 代码复用

	模块化程度更高、依赖更少的代码更容易复用。

- 更高效率

	使用 RTOS 的应用可以完全事件驱动，无需通过轮询来浪费处理时间等待尚未发生的事件。

	与事件驱动带来的效率相对应的是，需要处理 RTOS 的时钟节拍中断，并在任务间切换执行。
	然而，不使用 RTOS 的应用通常也会包含某种形式的节拍中断。

- 空闲时间

	当没有应用任务需要处理时，系统会自动创建并运行空闲任务。空闲任务可以测量
	处理器的空闲容量、执行后台检查，或将处理器置于低功耗模式。

- 电源管理

	使用 RTOS 带来的效率提升可让处理器有更多时间处于低功耗模式。

	每次空闲任务运行时将处理器置于低功耗状态，可显著降低功耗。
	FreeRTOS 还支持特殊的无节拍模式（tick-less）。使用无节拍模式可使处理器
	进入比常规情况下更低的功耗模式，并在低功耗模式中保持更长时间。

- 灵活的中断处理

	通过将处理过程延后到应用创建的任务或自动创建的 RTOS 守护任务（也称定时器任务），
	中断处理程序可以保持非常短小。

- 混合处理需求

	简单的设计模式即可在应用中实现周期性、连续性与事件驱动处理的混合。
	此外，通过选择合适的任务与中断优先级，可同时满足硬实时与软实时需求。


### 1.1.5 FreeRTOS 内核特性

FreeRTOS 内核具有以下标准特性：

- 抢占式或协作式运行
- 可选的时间片
- 极其灵活的任务优先级分配
- 灵活、快速且轻量级的任务通知机制
- 队列
- 二值信号量
- 计数信号量
- 互斥量
- 递归互斥量
- 软件定时器
- 事件组
- 流缓冲区
- 消息缓冲区
- 协程（已弃用）
- Tick 钩子函数
- 空闲钩子函数
- 栈溢出检查
- 跟踪宏
- 任务运行时统计收集
- 可选的商业许可与支持
- 完整的中断嵌套模型（适用于部分架构）
- 面向超低功耗应用的无节拍能力（适用于部分架构）
- 内存保护单元（MPU）支持，用于隔离任务并提升应用安全性（适用于部分架构）
- 在合适情况下由软件管理中断栈（可节省 RAM）
- 可使用静态或动态分配内存来创建 RTOS 对象


### 1.1.6 许可，以及 FreeRTOS、OpenRTOS 与 SafeRTOS 家族

**FreeRTOS** 的 MIT 开源许可旨在确保：

- FreeRTOS 可用于商业应用。

- FreeRTOS 本身对所有人保持免费可用。

- FreeRTOS 用户保留其知识产权的所有权。

最新开源许可信息见 <https://www.FreeRTOS.org/license>。

**OpenRTOS** 是由第三方在 Amazon Web Services 授权下提供的商业许可版本。

**SafeRTOS** 与 FreeRTOS 具有相同的使用模型，但其开发遵循了必要的实践、
流程与过程，以满足多项国际认可的安全相关标准的合规要求。


## 1.2 所含源文件与工程

### 1.2.1 获取本书配套示例

从 <https://www.FreeRTOS.org/Documentation/code> 提供的 zip 文件中可下载
本书示例所需的全部源代码、预配置的工程文件以及构建与运行示例的说明。
请注意该 zip 文件不一定包含 FreeRTOS 的最新版本。

本书中的屏幕截图展示了示例在 Microsoft Windows 环境下运行的情况，
使用的是 FreeRTOS Windows 移植层。该项目已预先配置为使用免费版的
Visual Studio Community 进行构建，可从 <https://www.visualstudio.com/> 获取。
请注意，尽管 FreeRTOS Windows 移植层提供了便捷的评估、测试与开发平台，
但它 *并不* 提供真正的实时行为。

```
